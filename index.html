<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PMTree</title>
    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="pmtree.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


        <!-- Custom styles for this template -->
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">PMTree</a>
        <div class="navbar-nav ml-auto">
          <a class="nav-item nav-link active" href="#">About PMTree</a>
        </div>
      </nav>

<main role="main">
  <!-- Main jumbotron for a primary marketing message or call to action -->
  <div class="jumbotron">
    <div class="container">
      <h1 class="display-3">PMTree</h1>
    </div>
  </div>


  <div class="container" id="mainsearch">
    <!-- Example row of columns -->
    <!--<div class="row">
      <div class="col-12">

        <h2>Your PubMed search</h2>
        <form class="form-inline">
        <div class="form-group mb-3">
          <input type="text" class="form-control" id="search">
        </div>
        <button id="runsearch" class="btn btn-primary mb-2" type="button">Search</button>
      </form>
      </div>
    </div>-->

    <div class="row">
    <div class="col-5">
      <h3>Your PubMed search:</h3>

      <div id="searchwords"></div>
        <form class="form-inline">
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="search">
        </div>
        <button id="runsearch" type="button" class="btn btn-primary mb-2">Search</button>
      </form>
      <form>
        <p>Search your term in:</p>
        <div>
          <input type="radio" id="type1"
           name="searchtype" value="tiab" checked>
          <label for="type1">Title and abstract</label>

          <input type="radio" id="type2"
           name="searchtype" value="any">
          <label for="type2">Anywhere</label>
        </div>
        <p>Dates to search:</p>
        <div>
          <input type="radio" id="years1"
           name="searchyears" value="ten" checked>
          <label for="years1">Last 10 years</label>

          <input type="radio" id="years2"
           name="searchyears" value="all">
          <label for="years2">All</label>
        </div>
      </form>

    </div>
    <div class="col-6" id="examplechart">
      <h4>Visualize your search results!</h4>
      <p>PMTree enables you to see how the concepts in the documents returned by your PubMed search
        relate to one another by using the <a href="https://ieeexplore-ieee-org.proxy-remote.galib.uga.edu/stamp/stamp.jsp?tp=&arnumber=4658133&tag=1">Word Tree</a>
        technique.
    </p>
    <img src="PubMed.PNG" alt="Example of a PubTrees chart" />
    </div>
    </div>

    <div class="row">
      <div class="col-md-8">

      </div>
      </div>

    <div class="row">
      <div class="col-md-10">
      <h4>How it works...</h4>
      <div class="row">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">1) Search your Terms</h5>
            <p class="card-text">Search with any PubMed search terms you like. You can use anything from a couple of keywords to the most complex search you can manage.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">2) Choose your Root</h5>
            <p class="card-text">Select one of your search terms (or choose any other word) to serve as the "root" of your tree. This term
            will be at the center of your diagram.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">3) View your Tree</h5>
            <p class="card-text">Other words and phrases from the citations captured by your search will be graphed in
            relation to the root of your tree. You can keep redrawing the graph by either changing the number of citations that are
          graphed or by selecting a different root. You can also <em>interact</em> with the tree by selecting individual terms.</p>
          </div>
        </div>
      </div>
      </div>
      </div>
      </div>


    </div>
    <hr>
  </div> <!-- /container -->
  <div id="chooseroot" class="container">
    <!-- Example row of columns -->
    <div class="row">
      <div class="col-md-8">
        <p>Your search returned <span id="returned"></span> PubMed results</p>
        <p>Select one of your search terms to see it as root...</p>
        <div id="searchwords"></div>
        <div id="rootwords"></div>
          <p>or choose your own different word:</p>
          <form class="form-inline">
          <div class="form-group mb-2">
            <input type="text" class="form-control" id="customword">
          </div>
          <button id="ownword" type="button" class="btn btn-primary mb-2">Draw</button>
        </form>
      </div>

      <div class="col-md-3">
      <form>
        <p>Draw your tree with how many results?</p>
        <div>
          <input type="radio" id="Choice1"
           name="howmany" value="50">
          <label for="Choice1">50</label>

          <input type="radio" id="Choice2"
           name="howmany" value="100" checked>
          <label for="Choice2">100</label>

          <input type="radio" id="Choice3"
           name="howmany" value="150">
          <label for="Choice3">150</label>
        </div>
      </form>
      </div>

    </div>

    <hr>

  </div> <!-- /container -->


  <div id="please-wait" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Please wait!</h4>
        </div>
        <div class="modal-body">
          <div class="loading">
          <p>Fetching your results...</p>
          <img src="loading-bars.svg">
        </div>
        </div>
      </div>
    </div>
  </div>

</main>

<footer class="container">
  <p>Made by Ed!</p>
</footer>
</body>

<script>

(function() {
  var current_datetime = new Date();
  var tenyearsago = new Date();
  tenyearsago.setFullYear(tenyearsago.getFullYear() - 10);
  var formatted_date = current_datetime.getFullYear() + "/" + (current_datetime.getMonth() + 1) + "/" + current_datetime.getDate();
  var formatted_old_date = tenyearsago.getFullYear() + "/" + (tenyearsago.getMonth() + 1) + "/" + tenyearsago.getDate();
  console.log(formatted_old_date);
  $( "#chooseroot" ).hide();
  $('#search').val("");
  var phrases = [];
  var query_key;
  var WebEnv;

  $(document).keydown(function(e) {
    if(e.keyCode == 13) {
      //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
      e.preventDefault();
      if($('#mainsearch').is(':visible')){
        $( "#runsearch" ).trigger( "click" );
      }
      if($('#chooseroot').is(':visible')){
        $( "#ownword" ).trigger( "click" );
      }
    }
  });

  $("#runsearch").click(function(){
     searchstr = $("#search").val();
     startSearch(searchstr);
   });

   $("#ownword").click(function(){
      var myword = $("#customword").val();
      getDocs( myword );
    });

   $( "#rootwords" ).on( "click", ".searchword", function() {
     var myword = $(this).text();
     getDocs( myword );
   });

   function startSearch(term) {
     $('#returned').empty();
     $( "#searchwords" ).empty();
     $( "#wordtree_basic" ).empty();
     $("#customword").val("");
     //$( "#chooseroot" ).hide();
     if ($( "input[name='searchtype']:checked" ).val() == "tiab") {
       term = term + "[tiab]";
     }
     if ($( "input[name='searchyears']:checked" ).val() == "ten") {
       term = term +' AND ("' + formatted_old_date + '"[PDAT] : "' + formatted_date + '"[PDAT])';
     }

     esearch(term)
     .then(function( data ) {
       var searchwords = searchstr.split(" ")
       for (i=0; i<searchwords.length; i++) {
         console.log(searchwords[i]);
         $( "#rootwords" ).append("<span class='searchword'>" + searchwords[i] + "</span>");
       }
       query_key = data.esearchresult.querykey;
       WebEnv = data.esearchresult.webenv;
       count = Number(data.esearchresult.count);
       if (count == 0) {
         alert("Sorry! Nothing found for your search...");
         location.reload();
       }

       $( "#returned" ).append(count.toLocaleString());
       $( "#chooseroot" ).show();
       $( "#mainsearch" ).hide();
       $( "#chooseroot" ).after('<div class="container" id="wordtree_basic">');
       var divWidth = $( "#chooseroot" ).innerWidth();
       console.log(divWidth);
       var chartwidth = divWidth*.9;
       var chartheight = chartwidth*.8;
       //if (chartwidth < 500) {
      //   alert("Minimum!");
      //   $( "#chooseroot" ).attr( "style", 'style="width: 700px; height: 560px;"' );
       //} else {
      //    $( "#chooseroot" ).attr( "style", 'style="width: ' + chartwidth + '; px; height: ' + chartheight + ' px;"' );
       //}

       //var rootword = $("#search").val();
       //getDocs( rootword );
     });
   }

   function esearch(term) {
        return $.ajax({
    url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
    data: {
    db: 'pubmed',
    usehistory: 'y',
    term: term,
    sort: 'relevance',
    retmode: 'json',
    retmax: 0,
    email: 'ed_sperr@hotmail.com',
    tool: 'pmtree'
    }
        });
   }

   function getDocs(rootword) {
        var doccount = $( "input[name='howmany']:checked" ).val();
        var efetchURL = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi";
        phrases.length = 0;
        $("#please-wait").modal();
        $.ajax({
          url: efetchURL,
          data: {
            db: 'pubmed',
            usehistory: 'y',
            WebEnv: WebEnv,
            query_key: query_key,
            retmode: 'xml',
            rettype: 'abstract',
            retmax: doccount },
        })
        .done(function( xml ) {
          $(xml).find('PubmedArticle').each(function(){
              var title = $(this).find("ArticleTitle").text();
              var abstract = $(this).find("AbstractText").text();
              console.log(abstract);
              var mytext = title + abstract;
              findMatch(mytext, rootword);
          });
          var myword = $("#search").val();
          if (phrases.length > 0) {
            drawChart( rootword );
          } else {
            alert("Sorry! Can't locate your word in the tree...");
            location.reload();
          }
        });
   }

   function findMatch( teststring, rootword ) {
     str1 = "[^\.\!\?]*[\.\!\?]";
     var re = new RegExp(str1, "gi");
     var res = teststring.match(re);
     if ( res ) {
         for (i=0; i < res.length; i++) {
         var myphrase = [ res[i] ];
         var retwo = new RegExp( rootword, "gi");
         if (retwo.test(myphrase)) {
           phrases.push(myphrase);
         }
       }
     }
   }

   google.charts.load('current', {packages:['wordtree']});
   function drawChart( myword ) {
      var data = google.visualization.arrayToDataTable( phrases );
      var options = {
        wordtree: {
          format: 'implicit',
          type: 'double',
          word: myword
        }
      };

      var chart = new google.visualization.WordTree(document.getElementById('wordtree_basic'));
      $('#please-wait').modal('hide');
      chart.draw(data, options);
      //var t1 = document.getElementById('wordtree_basic');
      if (document.getElementById('google-visualization-errors-all-1')) {
        $('#wordtree_basic').empty();
        alert("Your word cannot be found! Please choose another...");
      }
    }
})
();


</script>


</html>
